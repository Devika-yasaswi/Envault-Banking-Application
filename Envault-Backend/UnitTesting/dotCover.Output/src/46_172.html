<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\ENVAULT\Envault-Backend\DataAccessLayer\Infrastructure\CustomerRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ApplicationLayer.Interfaces;
using CoreModels.Entities;
using CoreModels.Models;
using Microsoft.AspNetCore.Http;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DataAccessLayer.Infrastructure
{
    public class CustomerRepository : ICustomerRepository
    {
        private readonly ApplicationDBContext _dbContext;
        public CustomerRepository(ApplicationDBContext dbContext)
        {
            _dbContext = dbContext;
        }
        //Returns basic details of the customer - For viewing Profile
        public BasicDetailsEntity GetBasicDetails(long customerId)
        {
            try
            {
                BasicDetailsEntity customerDetails = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == customerId).First();
                return customerDetails;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Returns stored addresses of the customer - For viewing Profile
        public CustomerAddressEntity GetCustomerAddress(long customerId)
        {
            try
            {
                CustomerAddressEntity customerDetails = _dbContext.Set&lt;CustomerAddressEntity&gt;().Where(customer =&gt; customer.CustomerId == customerId).First();
                return customerDetails;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Returns family and nominee details of the customer - For viewing Profile
        public CustomerFamilyAndNomineeDetailsEntity GetCustomerFamilyAndNomineeDetails(long customerId)
        {
            try
            {
                CustomerFamilyAndNomineeDetailsEntity customerDetails = _dbContext.Set&lt;CustomerFamilyAndNomineeDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == customerId).First();
                return customerDetails;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Updates the existing basic details of customer - Edit Profile invokes this
        public void EditBasicDetails(BasicDetailsEntity basicDetails)
        {
            try
            {
                BasicDetailsEntity customerDetails = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == basicDetails.CustomerId).First();
                customerDetails.EmployementType = basicDetails.EmployementType;
                customerDetails.AnnualIncome = basicDetails.AnnualIncome;
                customerDetails.ModifiedBy = basicDetails.CustomerEmail;
                customerDetails.ModifiedOn = DateTime.UtcNow;
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Updates the existing addresses of customer - Edit Profile invokes this
        public void EditCustomerAddress(CustomerAddressEntity customerAddress)
        {
            try
            {
                CustomerAddressEntity customerDetails = _dbContext.Set&lt;CustomerAddressEntity&gt;().Where(customer =&gt; customer.CustomerId == customerAddress.CustomerId).First();
                customerDetails.PermanentHouseNo = customerAddress.PermanentHouseNo;
                customerDetails.PermanentStreet = customerAddress.PermanentStreet;
                customerDetails.PermanentCity = customerAddress.PermanentCity;
                customerDetails.PermanentState = customerAddress.PermanentState;
                customerDetails.PermanentPincode = customerAddress.PermanentPincode;
                customerDetails.PresentHouseNo = customerAddress.PresentHouseNo;
                customerDetails.PresentStreet = customerAddress.PresentStreet;
                customerDetails.PresentCity = customerAddress.PresentCity;
                customerDetails.PresentState = customerAddress.PresentState;
                customerDetails.PresentPincode = customerAddress.PresentPincode;
                customerDetails.ModifiedBy = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == customerAddress.CustomerId).Select(customer =&gt; customer.CustomerEmail).FirstOrDefault();
                customerDetails.ModifiedOn = DateTime.UtcNow;
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Updates the existing Nominee details of customer - Edit Profile invokes this
        public void EditCustomerFamilyAndNomineeDetails(CustomerFamilyAndNomineeDetailsEntity customerFamilyAndNomineeDetails)
        {
            try
            {
                CustomerFamilyAndNomineeDetailsEntity customerDetails = _dbContext.Set&lt;CustomerFamilyAndNomineeDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == customerFamilyAndNomineeDetails.CustomerId).First();
                customerDetails.SpouseName = customerFamilyAndNomineeDetails.SpouseName;
                customerDetails.NomineeName = customerFamilyAndNomineeDetails.NomineeName;
                customerDetails.NomineeHouseNo = customerFamilyAndNomineeDetails.NomineeHouseNo;
                customerDetails.NomineeStreet = customerFamilyAndNomineeDetails.NomineeStreet;
                customerDetails.NomineeCity = customerFamilyAndNomineeDetails.NomineeCity;
                customerDetails.NomineeState = customerFamilyAndNomineeDetails.NomineeState;
                customerDetails.NomineePincode = customerFamilyAndNomineeDetails.NomineePincode;
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        public List&lt;AccountDetails&gt; GetAllAccounts(long customerId)
        {

            try
            {
                List&lt;AccountDetails&gt; accounts = _dbContext.Set&lt;AccountsEntity&gt;()
                        .Where(customer =&gt; customer.CustomerId == customerId)
                        .Join(_dbContext.Set&lt;AccountTypeEntity&gt;(),
                              account =&gt; account.AccountTypeId,
                              accountTypes =&gt; accountTypes.AccountTypeId,
                        (account, accountTypes) =&gt; new AccountDetails
                        {
                            AccountNumber = account.AccountNumber,
                            AccountType = accountTypes.AccountType,
                            AccountBalance = account.AccountBalance,
                            FreezeWithdrawl = account.FreezeWithdrawl,
                            MaxBalanceWarningAmount = account.MaxBalanceWarningAmount,
                            MinBalanceWarningAmount = account.MinBalanceWarningAmount
                        }).ToList();
                return accounts;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        public string KYCStatus(long customerId)
        {
            try
            {
                string kycStatus = _dbContext.Set&lt;KYCEntity&gt;().Where(customer =&gt; customer.CustomerId == customerId).Select(customer =&gt; customer.KYCStatus).FirstOrDefault();
                if (kycStatus != null)
                    return kycStatus;
                return kycStatus;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //KYC details will be addded into the data
        public void CompleteKYC(KYCModel customerKYCDetails)
        {
            try
            {
                KYCEntity? customerKYC = _dbContext.Set&lt;KYCEntity&gt;().Where(kyc =&gt; kyc.CustomerId == customerKYCDetails.CustomerId).FirstOrDefault();
                if (customerKYC == null)
                {
                    KYCEntity newCustomerKyc = new()
                    {
                        CustomerId = customerKYCDetails.CustomerId,
                        KYCStatus = &quot;uploaded&quot;,
                        AadharCard = Convert.FromBase64String(customerKYCDetails.AadharCard.Split(&#39;,&#39;)[1]),
                        PANCard = Convert.FromBase64String(customerKYCDetails.PANCard.Split(&quot;,&quot;)[1]),
                        CustomerPhoto = Convert.FromBase64String(customerKYCDetails.CustomerPhoto.Split(&quot;,&quot;)[1]),
                        CreatedBy = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == customerKYCDetails.CustomerId).Select(customer =&gt; customer.CustomerEmail).FirstOrDefault()
                    };
                    newCustomerKyc.ModifiedBy = newCustomerKyc.CreatedBy;
                    _dbContext.Set&lt;KYCEntity&gt;().Add(newCustomerKyc);
                }
                else
                {
                    customerKYC.AadharCard = Convert.FromBase64String(customerKYCDetails.AadharCard.Split(&#39;,&#39;)[1]);
                    customerKYC.PANCard = Convert.FromBase64String(customerKYCDetails.PANCard.Split(&quot;,&quot;)[1]);
                    customerKYC.CustomerPhoto = Convert.FromBase64String(customerKYCDetails.CustomerPhoto.Split(&quot;,&quot;)[1]);
                    customerKYC.KYCStatus = &quot;uploaded&quot;;
                    customerKYC.ModifiedBy = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == customerKYCDetails.CustomerId).Select(customer =&gt; customer.CustomerEmail).FirstOrDefault();
                    customerKYC.ModifiedOn = DateTime.UtcNow;
                }
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Deposits money into customer account
        public void DepositMoney(TransactionsEntity transactionDetails)
        {
            try
            {
                transactionDetails.SenderAccountNumber = transactionDetails.ReceiverAccountNumber;
                transactionDetails.TransactionTime = DateTime.UtcNow;
                transactionDetails.Remarks = &quot;Amount Deposit by self&quot;;
                transactionDetails.CreatedBy = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == transactionDetails.SenderAccountNumber)
                                                .Join(_dbContext.Set&lt;BasicDetailsEntity&gt;(),
                                                      account =&gt; account.CustomerId,
                                                      basicDetails =&gt; basicDetails.CustomerId,
                                                      (account, basicDetails) =&gt; new { basicDetails.CustomerEmail })
                                                .Select(result =&gt; result.CustomerEmail).FirstOrDefault();
                transactionDetails.ModifiedBy = transactionDetails.CreatedBy;
                AccountsEntity accountDetails = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == transactionDetails.SenderAccountNumber).First();
                accountDetails.AccountBalance = accountDetails.AccountBalance + transactionDetails.Amount;
                _dbContext.Set&lt;TransactionsEntity&gt;().Add(transactionDetails);
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whether the account number exists or not
        public bool IsValidAccountNumber(long accountNumber)
        {
            try
            {
                AccountsEntity? account = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).FirstOrDefault();
                if (account != null)
                    return true;
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whether user has sufficient balance to perform transaction or not
        public bool HasSufficientBalance(long accountNumber, double amount)
        {
            try
            {
                AccountsEntity accountDetails = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).First();
                if (accountDetails.AccountBalance &lt; amount)
                    return false;
                return true;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whether the balance is exceeding the min threshold value or not
        public bool IsExceedingMinBalanceWarningAmount(long accountNumber, double amount)
        {
            try
            {
                AccountsEntity accountDetails = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).First();
                if (accountDetails.AccountBalance - amount &lt; accountDetails.MinBalanceWarningAmount &amp;&amp; accountDetails.MinBalanceWarningAmount != 0)
                    return true;
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whether the balance is exceeding the max threshold value or not
        public bool IsExceedingMaxBalanceWarningAmount(long accountNumber, double amount)
        {
            try
            {
                AccountsEntity accountDetails = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).First();
                if (accountDetails.AccountBalance + amount &gt; accountDetails.MaxBalanceWarningAmount &amp;&amp; accountDetails.MaxBalanceWarningAmount != 0)
                    return true;
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Internal fund transfer will be done
        public void TransferMoney(TransactionsEntity transactionDetails)
        {
            try
            {
                var accounts = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == transactionDetails.SenderAccountNumber || account.AccountNumber == transactionDetails.ReceiverAccountNumber).ToList();
                AccountsEntity senderAccount = accounts.Where(account =&gt; account.AccountNumber == transactionDetails.SenderAccountNumber).First();
                senderAccount.AccountBalance = senderAccount.AccountBalance - transactionDetails.Amount;
                AccountsEntity receiverAccount = accounts.Where(account =&gt; account.AccountNumber == transactionDetails.ReceiverAccountNumber).First();
                receiverAccount.AccountBalance = receiverAccount.AccountBalance + transactionDetails.Amount;
                transactionDetails.TransactionTime = DateTime.UtcNow;
                transactionDetails.CreatedBy = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == transactionDetails.SenderAccountNumber)
                                                .Join(_dbContext.Set&lt;BasicDetailsEntity&gt;(),
                                                      account =&gt; account.CustomerId,
                                                      basicDetails =&gt; basicDetails.CustomerId,
                                                      (account, basicDetails) =&gt; new { basicDetails.CustomerEmail })
                                                .Select(result =&gt; result.CustomerEmail).FirstOrDefault();
                transactionDetails.ModifiedBy = transactionDetails.CreatedBy;
                _dbContext.Set&lt;TransactionsEntity&gt;().Add(transactionDetails);
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Edits balance threshold value - customer will get an alert if the balance decreases more than that
        public void EditThresholdValue(long accountNumber, double minBalanceWarningAmount, double maxBalanceWarningAmount)
        {
            try
            {
                AccountsEntity accountDetails = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).First();
                if (accountDetails != null)
                {
                    accountDetails.MinBalanceWarningAmount = minBalanceWarningAmount;
                    accountDetails.MaxBalanceWarningAmount = maxBalanceWarningAmount;
                    accountDetails.ModifiedOn = DateTime.UtcNow;
                    _dbContext.SaveChanges();
                }
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Freezes withdrawls of the customer
        public void FreezeWithdrawls(long accountNumber)
        {
            try
            {
                AccountsEntity account = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).First();
                account.FreezeWithdrawl = true;
                account.ModifiedOn = DateTime.UtcNow;
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Unfreezes the account and allows customer to transfer/ withdraw their amount
        public void UnFreezeWithdrawls(long accountNumber)
        {
            try
            {
                AccountsEntity account = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountNumber == accountNumber).First();
                account.FreezeWithdrawl = false;
                account.ModifiedOn = DateTime.UtcNow;
                _dbContext.SaveChanges();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Gives all the transactions of the customer based on their account number
        public List&lt;TransactionsEntity&gt; GetAllTransactions(long accountNumber)
        {
            try
            {
                return _dbContext.Set&lt;TransactionsEntity&gt;().Where(transaction =&gt; transaction.SenderAccountNumber == accountNumber || transaction.ReceiverAccountNumber == accountNumber).OrderByDescending(transaction =&gt; transaction.TransactionTime).ToList();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,66,1],[17,9,17,10,1],[18,13,18,36,1],[19,9,19,10,1],[22,9,22,10,0],[24,13,24,14,0],[25,17,25,152,0],[26,17,26,40,0],[28,13,28,33,0],[29,13,29,14,0],[30,17,30,49,0],[32,9,32,10,0],[35,9,35,10,0],[37,13,37,14,0],[38,17,38,158,0],[39,17,39,40,0],[41,13,41,33,0],[42,13,42,14,0],[43,17,43,49,0],[45,9,45,10,0],[48,9,48,10,0],[50,13,50,14,0],[51,17,51,190,0],[52,17,52,40,0],[54,13,54,33,0],[55,13,55,14,0],[56,17,56,49,0],[58,9,58,10,0],[61,9,61,10,0],[63,13,63,14,0],[64,17,64,165,0],[65,17,65,80,0],[66,17,66,74,0],[67,17,67,73,0],[68,17,68,62,0],[69,17,69,42,0],[70,13,70,14,0],[71,13,71,33,0],[72,13,72,14,0],[73,17,73,49,0],[75,9,75,10,0],[78,9,78,10,0],[80,13,80,14,0],[81,17,81,174,0],[82,17,82,85,0],[83,17,83,83,0],[84,17,84,79,0],[85,17,85,81,0],[86,17,86,85,0],[87,17,87,81,0],[88,17,88,79,0],[89,17,89,75,0],[90,17,90,77,0],[91,17,91,81,0],[92,17,92,212,0],[93,17,93,62,0],[94,17,94,42,0],[95,13,95,14,0],[96,13,96,33,0],[97,13,97,14,0],[98,17,98,49,0],[100,9,100,10,0],[103,9,103,10,0],[105,13,105,14,0],[106,17,106,222,0],[107,17,107,89,0],[108,17,108,91,0],[109,17,109,97,0],[110,17,110,95,0],[111,17,111,91,0],[112,17,112,93,0],[113,17,113,97,0],[114,17,114,42,0],[115,13,115,14,0],[116,13,116,33,0],[117,13,117,14,0],[118,17,118,49,0],[120,9,120,10,0],[122,9,122,10,0],[125,13,125,14,0],[126,17,139,37,0],[140,17,140,33,0],[142,13,142,33,0],[143,13,143,14,0],[144,17,144,49,0],[146,9,146,10,0],[148,9,148,10,0],[150,13,150,14,0],[151,17,151,173,0],[152,17,152,39,0],[153,21,153,38,0],[154,17,154,34,0],[156,13,156,33,0],[157,13,157,14,0],[158,17,158,49,0],[160,9,160,10,0],[163,9,163,10,0],[165,13,165,14,0],[166,17,166,149,0],[167,17,167,41,0],[168,17,168,18,0],[169,21,177,23,0],[178,21,178,74,0],[179,21,179,69,0],[180,17,180,18,0],[182,17,182,18,0],[183,21,183,116,0],[184,21,184,110,0],[185,21,185,122,0],[186,21,186,56,0],[187,21,187,215,0],[188,21,188,62,0],[189,17,189,18,0],[190,17,190,42,0],[191,13,191,14,0],[192,13,192,33,0],[193,13,193,14,0],[194,17,194,49,0],[196,9,196,10,0],[199,9,199,10,0],[201,13,201,14,0],[202,17,202,99,0],[203,17,203,70,0],[204,17,204,71,0],[205,17,210,106,0],[211,17,211,78,0],[212,17,212,172,0],[213,17,213,107,0],[214,17,214,78,0],[215,17,215,42,0],[216,13,216,14,0],[217,13,217,33,0],[218,13,218,14,0],[219,17,219,49,0],[221,9,221,10,0],[224,9,224,10,0],[226,13,226,14,0],[227,17,227,150,0],[228,17,228,37,0],[229,21,229,33,0],[230,17,230,30,0],[232,13,232,33,0],[233,13,233,14,0],[234,17,234,49,0],[236,9,236,10,0],[239,9,239,10,0],[241,13,241,14,0],[242,17,242,147,0],[243,17,243,60,0],[244,21,244,34,0],[245,17,245,29,0],[247,13,247,33,0],[248,13,248,14,0],[249,17,249,49,0],[251,9,251,10,0],[254,9,254,10,0],[256,13,256,14,0],[257,17,257,147,0],[258,17,258,148,0],[259,21,259,33,0],[260,17,260,30,0],[262,13,262,33,0],[263,13,263,14,0],[264,17,264,49,0],[266,9,266,10,0],[269,9,269,10,0],[271,13,271,14,0],[272,17,272,147,0],[273,17,273,148,0],[274,21,274,33,0],[275,17,275,30,0],[277,13,277,33,0],[278,13,278,14,0],[279,17,279,49,0],[281,9,281,10,0],[284,9,284,10,0],[286,13,286,14,0],[287,17,287,225,0],[288,17,288,74,0],[288,74,288,137,0],[288,137,288,147,0],[289,17,289,105,0],[290,17,290,76,0],[290,76,290,141,0],[290,141,290,151,0],[291,17,291,109,0],[292,17,292,70,0],[293,17,298,106,0],[299,17,299,78,0],[300,17,300,78,0],[301,17,301,42,0],[302,13,302,14,0],[303,13,303,33,0],[304,13,304,14,0],[305,17,305,49,0],[307,9,307,10,0],[310,9,310,10,0],[312,13,312,14,0],[313,17,313,147,0],[314,17,314,44,0],[315,17,315,18,0],[316,21,316,86,0],[317,21,317,86,0],[318,21,318,65,0],[319,21,319,46,0],[320,17,320,18,0],[321,13,321,14,0],[322,13,322,33,0],[323,13,323,14,0],[324,17,324,49,0],[326,9,326,10,0],[329,9,329,10,0],[331,13,331,14,0],[332,17,332,140,0],[333,17,333,48,0],[334,17,334,54,0],[335,17,335,42,0],[336,13,336,14,0],[337,13,337,33,0],[338,13,338,14,0],[339,17,339,49,0],[341,9,341,10,0],[344,9,344,10,0],[346,13,346,14,0],[347,17,347,140,0],[348,17,348,49,0],[349,17,349,54,0],[350,17,350,42,0],[351,13,351,14,0],[352,13,352,33,0],[353,13,353,14,0],[354,17,354,49,0],[356,9,356,10,0],[359,9,359,10,0],[361,13,361,14,0],[362,17,362,257,0],[364,13,364,33,0],[365,13,365,14,0],[366,17,366,49,0],[368,9,368,10,0]]);
    </script>
  </body>
</html>