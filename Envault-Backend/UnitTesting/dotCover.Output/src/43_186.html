<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\ENVAULT\Envault-Backend\DataAccessLayer\Infrastructure\AccountOpeningRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ApplicationLayer.Interfaces;
using CoreModels.Entities;
using CoreModels.Models;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DataAccessLayer.Infrastructure
{
    public class AccountOpeningRepository : IAccountOpeningRepository
    {
        private readonly ApplicationDBContext _dbContext;
        public AccountOpeningRepository(ApplicationDBContext dbContext)
        {
            _dbContext = dbContext;
        }
        //Checks whether the user exists or not - Used for creating new Account
        public BasicDetailsEntity? CheckUserExistence(long aadharNumber, long mobileNumber, DateOnly dateOfBirth)
        {
            try
            {
                return _dbContext.Set&lt;BasicDetailsEntity&gt;().Include(customer =&gt; customer.CustomerAddress).Include(customer =&gt; customer.CustomerFamilyAndNomineeDetails).Where(customer =&gt; customer.AadharNumber == aadharNumber &amp;&amp; customer.MobileNumber == mobileNumber &amp;&amp; customer.DateOfBirth == dateOfBirth).FirstOrDefault();
            }
            catch(Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whethers the email is unique or not - Used for creating new Account
        public bool IsUniqueEmail(string email)
        {
            try
            {
                BasicDetailsEntity? customer = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerEmail == email).FirstOrDefault();
                if (customer == null)
                {
                    return true;
                }
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whethers the PAN Number is unique or not - Used for creating new Account
        public bool IsUniquePANNumber(string panNumber)
        {
            try
            {
                BasicDetailsEntity? customer = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.PANNumber == panNumber).FirstOrDefault();
                if(customer == null)
                {
                    return true;
                }
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //returns all the branches available in the bank
        public List&lt;BranchDetails&gt; GetAllBranches()
        {
            return _dbContext.Set&lt;BranchEntity&gt;().Where(branch =&gt; branch.IsActive).Select(branch =&gt; new BranchDetails { BranchID = branch.BranchID ,BranchLocatedState = branch.BranchLocatedState, City = branch.City, BranchAddress = branch.BranchAddress, IFSCCode = branch.IFSCCode}).ToList();
        }
        public AccountsEntity GenerateAccountNumber(AccountsEntity account)
        {
            try
            {
                if (account.AccountTypeId == 1 || account.AccountTypeId == 2 || account.AccountTypeId == 3 || account.AccountTypeId == 4 || account.AccountTypeId == 5 || account.AccountTypeId == 6)
                {
                    long accountNumber = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountTypeId == 1 || account.AccountTypeId == 2 || account.AccountTypeId == 3 || account.AccountTypeId == 4 || account.AccountTypeId == 5 || account.AccountTypeId == 6).OrderByDescending(account =&gt; account.AccountNumber).Select(account =&gt; account.AccountNumber).FirstOrDefault();
                    if (accountNumber != 0)
                    {
                        account.AccountNumber = accountNumber + 1;
                    }
                    else
                    {
                        account.AccountNumber = 100000000001;
                    }
                }
                else if (account.AccountTypeId == 7)
                {
                    long accountNumber = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountTypeId == 7).OrderByDescending(account =&gt; account.AccountNumber).Select(account =&gt; account.AccountNumber).FirstOrDefault();
                    if (accountNumber != 0)
                    {
                        account.AccountNumber = accountNumber + 1;
                    }
                    else
                    {
                        account.AccountNumber = 500000000001;
                    }
                }
                else if (account.AccountTypeId == 8 || account.AccountTypeId == 9 || account.AccountTypeId == 10 || account.AccountTypeId == 11 || account.AccountTypeId == 12 || account.AccountTypeId == 13 || account.AccountTypeId == 14)
                {
                    long accountNumber = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountTypeId == 8 || account.AccountTypeId == 9 || account.AccountTypeId == 10 || account.AccountTypeId == 11 || account.AccountTypeId == 12 || account.AccountTypeId == 13 || account.AccountTypeId == 14).OrderByDescending(account =&gt; account.AccountNumber).Select(account =&gt; account.AccountNumber).FirstOrDefault();
                    if (accountNumber != 0)
                    {
                        account.AccountNumber = accountNumber + 1;
                    }
                    else
                    {
                        account.AccountNumber = 700000000001;
                    }
                }
                return account;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Creates New Account for the user - For first account of customer
        public Object CreateNewAccount(BasicDetailsEntity basicDetails)
        {
            try
            {
                basicDetails.CreatedBy = basicDetails.CustomerEmail;
                basicDetails.ModifiedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerAddress.CreatedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerAddress.ModifiedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerFamilyAndNomineeDetails.CreatedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerFamilyAndNomineeDetails.ModifiedBy = basicDetails.CustomerEmail;
                AccountsEntity account = basicDetails.Accounts.First();
                account = GenerateAccountNumber(account);
                foreach (AccountsEntity accountCreated in basicDetails.Accounts)
                {
                    accountCreated.CreatedBy = basicDetails.CustomerEmail;
                    accountCreated.ModifiedBy = basicDetails.CustomerEmail;
                }
                _dbContext.Set&lt;BasicDetailsEntity&gt;().Add(basicDetails);
                _dbContext.SaveChanges();
                return new { customerId = basicDetails.CustomerId, accountNumber = account.AccountNumber };
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Creates another account for customer - only for existing customer
        public Object CreateAnotherAccount(AccountsEntity account)
        {
            try
            {
                account.CreatedBy = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == account.CustomerId).Select(customer =&gt; customer.CustomerEmail).FirstOrDefault();
                account.ModifiedBy = account.CreatedBy;
                account = GenerateAccountNumber(account);
                _dbContext.Set&lt;AccountsEntity&gt;().Add(account);
                _dbContext.SaveChanges();
                return new { customerId = account.CustomerId, accountNumber = account.AccountNumber };
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,72,0],[17,9,17,10,0],[18,13,18,36,0],[19,9,19,10,0],[22,9,22,10,0],[24,13,24,14,0],[25,17,25,323,0],[27,13,27,32,0],[28,13,28,14,0],[29,17,29,49,0],[31,9,31,10,0],[34,9,34,10,0],[36,13,36,14,0],[37,17,37,153,0],[38,17,38,38,0],[39,17,39,18,0],[40,21,40,33,0],[42,17,42,30,0],[44,13,44,33,0],[45,13,45,14,0],[46,17,46,49,0],[48,9,48,10,0],[51,9,51,10,0],[53,13,53,14,0],[54,17,54,153,0],[55,17,55,37,0],[56,17,56,18,0],[57,21,57,33,0],[59,17,59,30,0],[61,13,61,33,0],[62,13,62,14,0],[63,17,63,49,0],[65,9,65,10,0],[68,9,68,10,0],[69,13,69,293,0],[70,9,70,10,0],[72,9,72,10,0],[74,13,74,14,0],[75,17,75,198,0],[76,17,76,18,0],[77,21,77,380,0],[78,21,78,44,0],[79,21,79,22,0],[80,25,80,67,0],[81,21,81,22,0],[83,21,83,22,0],[84,25,84,62,0],[85,21,85,22,0],[86,17,86,18,0],[87,22,87,53,0],[88,17,88,18,0],[89,21,89,230,0],[90,21,90,44,0],[91,21,91,22,0],[92,25,92,67,0],[93,21,93,22,0],[95,21,95,22,0],[96,25,96,62,0],[97,21,97,22,0],[98,17,98,18,0],[99,22,99,238,0],[100,17,100,18,0],[101,21,101,415,0],[102,21,102,44,0],[103,21,103,22,0],[104,25,104,67,0],[105,21,105,22,0],[107,21,107,22,0],[108,25,108,62,0],[109,21,109,22,0],[110,17,110,18,0],[111,17,111,32,0],[113,13,113,33,0],[114,13,114,14,0],[115,17,115,49,0],[117,9,117,10,0],[120,9,120,10,0],[122,13,122,14,0],[123,17,123,69,0],[124,17,124,70,0],[125,17,125,85,0],[126,17,126,86,0],[127,17,127,101,0],[128,17,128,102,0],[129,17,129,72,0],[130,17,130,58,0],[131,17,131,24,0],[131,26,131,55,0],[131,56,131,58,0],[131,59,131,80,0],[132,17,132,18,0],[133,21,133,75,0],[134,21,134,76,0],[135,17,135,18,0],[136,17,136,72,0],[137,17,137,42,0],[138,17,138,108,0],[140,13,140,33,0],[141,13,141,14,0],[142,17,142,49,0],[144,9,144,10,0],[147,9,147,10,0],[149,13,149,14,0],[150,17,150,195,0],[151,17,151,56,0],[152,17,152,58,0],[153,17,153,63,0],[154,17,154,42,0],[155,17,155,103,0],[157,13,157,33,0],[158,13,158,14,0],[159,17,159,49,0],[161,9,161,10,0]]);
    </script>
  </body>
</html>