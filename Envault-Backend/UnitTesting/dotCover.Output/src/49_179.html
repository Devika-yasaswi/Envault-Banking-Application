<!DOCTYPE html>
<html>
  <head>
    <meta http-equiv="content-type" content="text/html; charset=utf-8" />
    <title>C:\ENVAULT\Envault-Backend\DataAccessLayer\Infrastructure\AccountOpeningRepository.cs</title>
    <script type="text/javascript" src="../js/dotcover.sourceview.js"></script>
    <link rel="stylesheet" type="text/css" href="../css/dotcover.report.css" />
  </head>
  <body>
    <pre id="content" class="source-code">
using ApplicationLayer.Interfaces;
using CoreModels.Entities;
using CoreModels.Models;
using Microsoft.EntityFrameworkCore;
using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using System.Threading.Tasks;

namespace DataAccessLayer.Infrastructure
{
    public class AccountOpeningRepository : IAccountOpeningRepository
    {
        private readonly ApplicationDBContext _dbContext;
        public AccountOpeningRepository(ApplicationDBContext dbContext)
        {
            _dbContext = dbContext;
        }
        //Checks whether the user exists or not - Used for creating new Account
        public BasicDetailsEntity? CheckUserExistence(long aadharNumber, long mobileNumber, DateOnly dateOfBirth)
        {
            try
            {
                return _dbContext.Set&lt;BasicDetailsEntity&gt;().Include(customer =&gt; customer.CustomerAddress).Include(customer =&gt; customer.CustomerFamilyAndNomineeDetails).Where(customer =&gt; customer.AadharNumber == aadharNumber &amp;&amp; customer.MobileNumber == mobileNumber &amp;&amp; customer.DateOfBirth == dateOfBirth).FirstOrDefault();
            }
            catch(Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whethers the email is unique or not - Used for creating new Account
        public bool IsUniqueEmail(string email)
        {
            try
            {
                BasicDetailsEntity? customer = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerEmail == email).FirstOrDefault();
                if (customer == null)
                {
                    return true;
                }
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Checks whethers the PAN Number is unique or not - Used for creating new Account
        public bool IsUniquePANNumber(string panNumber)
        {
            try
            {
                BasicDetailsEntity? customer = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.PANNumber == panNumber).FirstOrDefault();
                if(customer == null)
                {
                    return true;
                }
                return false;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //returns all the branches available in the bank
        public List&lt;BranchDetails&gt; GetAllBranches()
        {
            try
            {
                return _dbContext.Set&lt;BranchEntity&gt;().Where(branch =&gt; branch.IsActive).Select(branch =&gt; new BranchDetails { BranchID = branch.BranchID ,BranchLocatedState = branch.BranchLocatedState, City = branch.City, BranchAddress = branch.BranchAddress, IFSCCode = branch.IFSCCode}).ToList();
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        public AccountsEntity GenerateAccountNumber(AccountsEntity account)
        {
            try
            {
                if (account.AccountTypeId == 1 || account.AccountTypeId == 2 || account.AccountTypeId == 3 || account.AccountTypeId == 4 || account.AccountTypeId == 5 || account.AccountTypeId == 6)
                {
                    long accountNumber = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountTypeId == 1 || account.AccountTypeId == 2 || account.AccountTypeId == 3 || account.AccountTypeId == 4 || account.AccountTypeId == 5 || account.AccountTypeId == 6).OrderByDescending(account =&gt; account.AccountNumber).Select(account =&gt; account.AccountNumber).FirstOrDefault();
                    if (accountNumber != 0)
                    {
                        account.AccountNumber = accountNumber + 1;
                    }
                    else
                    {
                        account.AccountNumber = 100000000001;
                    }
                }
                else if (account.AccountTypeId == 7)
                {
                    long accountNumber = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountTypeId == 7).OrderByDescending(account =&gt; account.AccountNumber).Select(account =&gt; account.AccountNumber).FirstOrDefault();
                    if (accountNumber != 0)
                    {
                        account.AccountNumber = accountNumber + 1;
                    }
                    else
                    {
                        account.AccountNumber = 500000000001;
                    }
                }
                else if (account.AccountTypeId == 8 || account.AccountTypeId == 9 || account.AccountTypeId == 10 || account.AccountTypeId == 11 || account.AccountTypeId == 12 || account.AccountTypeId == 13 || account.AccountTypeId == 14)
                {
                    long accountNumber = _dbContext.Set&lt;AccountsEntity&gt;().Where(account =&gt; account.AccountTypeId == 8 || account.AccountTypeId == 9 || account.AccountTypeId == 10 || account.AccountTypeId == 11 || account.AccountTypeId == 12 || account.AccountTypeId == 13 || account.AccountTypeId == 14).OrderByDescending(account =&gt; account.AccountNumber).Select(account =&gt; account.AccountNumber).FirstOrDefault();
                    if (accountNumber != 0)
                    {
                        account.AccountNumber = accountNumber + 1;
                    }
                    else
                    {
                        account.AccountNumber = 700000000001;
                    }
                }
                return account;
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Creates New Account for the user - For first account of customer
        public Object CreateNewAccount(BasicDetailsEntity basicDetails)
        {
            try
            {
                basicDetails.CreatedBy = basicDetails.CustomerEmail;
                basicDetails.ModifiedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerAddress.CreatedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerAddress.ModifiedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerFamilyAndNomineeDetails.CreatedBy = basicDetails.CustomerEmail;
                basicDetails.CustomerFamilyAndNomineeDetails.ModifiedBy = basicDetails.CustomerEmail;
                AccountsEntity account = basicDetails.Accounts.First();
                account = GenerateAccountNumber(account);
                foreach (AccountsEntity accountCreated in basicDetails.Accounts)
                {
                    accountCreated.CreatedBy = basicDetails.CustomerEmail;
                    accountCreated.ModifiedBy = basicDetails.CustomerEmail;
                }
                _dbContext.Set&lt;BasicDetailsEntity&gt;().Add(basicDetails);
                _dbContext.SaveChanges();
                return new { customerId = basicDetails.CustomerId, accountNumber = account.AccountNumber };
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
        //Creates another account for customer - only for existing customer
        public Object CreateAnotherAccount(AccountsEntity account)
        {
            try
            {
                account.CreatedBy = _dbContext.Set&lt;BasicDetailsEntity&gt;().Where(customer =&gt; customer.CustomerId == account.CustomerId).Select(customer =&gt; customer.CustomerEmail).FirstOrDefault();
                account.ModifiedBy = account.CreatedBy;
                account = GenerateAccountNumber(account);
                _dbContext.Set&lt;AccountsEntity&gt;().Add(account);
                _dbContext.SaveChanges();
                return new { customerId = account.CustomerId, accountNumber = account.AccountNumber };
            }
            catch (Exception ex)
            {
                throw new Exception(ex.Message);
            }
        }
    }
}

    </pre>
    <script type="text/javascript">
      highlightRanges([[16,9,16,72,1],[17,9,17,10,1],[18,13,18,36,1],[19,9,19,10,1],[22,9,22,10,1],[24,13,24,14,1],[25,17,25,323,1],[27,13,27,32,1],[28,13,28,14,1],[29,17,29,49,1],[31,9,31,10,1],[34,9,34,10,1],[36,13,36,14,1],[37,17,37,153,1],[38,17,38,38,1],[39,17,39,18,1],[40,21,40,33,1],[42,17,42,30,1],[44,13,44,33,1],[45,13,45,14,1],[46,17,46,49,1],[48,9,48,10,1],[51,9,51,10,1],[53,13,53,14,1],[54,17,54,153,1],[55,17,55,37,1],[56,17,56,18,1],[57,21,57,33,1],[59,17,59,30,1],[61,13,61,33,1],[62,13,62,14,1],[63,17,63,49,1],[65,9,65,10,1],[68,9,68,10,1],[70,13,70,14,1],[71,17,71,297,1],[73,13,73,33,1],[74,13,74,14,1],[75,17,75,49,1],[77,9,77,10,1],[79,9,79,10,1],[81,13,81,14,1],[82,17,82,198,1],[83,17,83,18,1],[84,21,84,380,1],[85,21,85,44,1],[86,21,86,22,1],[87,25,87,67,1],[88,21,88,22,1],[90,21,90,22,0],[91,25,91,62,0],[92,21,92,22,0],[93,17,93,18,1],[94,22,94,53,1],[95,17,95,18,1],[96,21,96,230,1],[97,21,97,44,1],[98,21,98,22,0],[99,25,99,67,0],[100,21,100,22,0],[102,21,102,22,1],[103,25,103,62,1],[104,21,104,22,1],[105,17,105,18,1],[106,22,106,238,1],[107,17,107,18,1],[108,21,108,415,1],[109,21,109,44,1],[110,21,110,22,0],[111,25,111,67,0],[112,21,112,22,0],[114,21,114,22,1],[115,25,115,62,1],[116,21,116,22,1],[117,17,117,18,1],[118,17,118,32,1],[120,13,120,33,1],[121,13,121,14,1],[122,17,122,49,1],[124,9,124,10,1],[127,9,127,10,1],[129,13,129,14,1],[130,17,130,69,1],[131,17,131,70,1],[132,17,132,85,1],[133,17,133,86,0],[134,17,134,101,0],[135,17,135,102,0],[136,17,136,72,0],[137,17,137,58,0],[138,17,138,24,0],[138,26,138,55,0],[138,56,138,58,0],[138,59,138,80,0],[139,17,139,18,0],[140,21,140,75,0],[141,21,141,76,0],[142,17,142,18,0],[143,17,143,72,0],[144,17,144,42,0],[145,17,145,108,0],[147,13,147,33,1],[148,13,148,14,1],[149,17,149,49,1],[151,9,151,10,0],[154,9,154,10,0],[156,13,156,14,0],[157,17,157,195,0],[158,17,158,56,0],[159,17,159,58,0],[160,17,160,63,0],[161,17,161,42,0],[162,17,162,103,0],[164,13,164,33,0],[165,13,165,14,0],[166,17,166,49,0],[168,9,168,10,0]]);
    </script>
  </body>
</html>